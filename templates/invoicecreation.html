{% extends 'base.html' %}
{% import '_components.html' as ui %}
{% block content %}
  <h1>{{ t('invoice_title') }}</h1>
  <form method="post" action="{{ url_for('invoicecreation_post') }}" enctype="multipart/form-data">
    {% call ui.card() %}
      {% call ui.field(t('dropdown_label_search'), 'client_name') %}
        <div class="combo" style="position:relative;">
          <input type="text" id="combo_input" placeholder="{{ t('search_placeholder') }}" autocomplete="off">
          <input type="hidden" id="client_name" name="client_name" required>
          <div id="combo_list" class="combo-list" style="position:absolute; z-index:10; width:100%; max-height:220px; overflow:auto; display:none;"></div>
        </div>
      {% endcall %}
      {% call ui.field(t('delivery_label'), 'delivery_notes') %}
        <input type="file" id="delivery_notes" name="delivery_notes" accept=".pdf" multiple>
      {% endcall %}
      {{ ui.button(t('generate_button')) }}
    {% endcall %}
  </form>
  <script>
    const comboInput = document.getElementById('combo_input');
    const comboList = document.getElementById('combo_list');
    const hiddenInput = document.getElementById('client_name');
    let items = [];
    let open = false;
    let timer = null;

    function openList(){ comboList.style.display = 'block'; open = true; }
    function closeList(){ comboList.style.display = 'none'; open = false; }
    function renderList(filter){
      comboList.innerHTML = '';
      const q = (filter || '').toLowerCase();
      // Textual search: split query into tokens AND do accent-insensitive compare
      const normalize = (s) => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const tokens = normalize(q).split(/\s+/).filter(Boolean);
      const filtered = tokens.length ? items.filter(v => {
        const s = normalize(v);
        return tokens.every(t => s.includes(t));
      }) : items;
      if(filtered.length === 0){ closeList(); return; }
      filtered.forEach(v => {
        const opt = document.createElement('div');
        opt.textContent = v;
        opt.className = 'combo-item';
        opt.style.padding = '8px';
        opt.style.cursor = 'pointer';
        opt.addEventListener('mousedown', () => { // mousedown to fire before input blur
          comboInput.value = v;
          hiddenInput.value = v;
          closeList();
        });
        comboList.appendChild(opt);
      });
    }
    async function fetchCustomers(q){
      const url = q ? (`/api/customers?q=` + encodeURIComponent(q)) : '/api/customers';
      const resp = await fetch(url);
      if(!resp.ok) return;
      items = await resp.json();
      renderList(q);
    }
    comboInput.addEventListener('input', () => {
      hiddenInput.value = '';
      if(timer) clearTimeout(timer);
      const q = comboInput.value.trim();
      // local filter immediately for fast UX
      renderList(q);
      // also refresh from server after debounce to support backend filtering
      timer = setTimeout(() => fetchCustomers(q), 250);
      openList();
    });
    comboInput.addEventListener('click', () => {
      // toggle open on click without auto-opening on page load
      if(comboList.style.display === 'block'){ closeList(); }
      else { renderList(comboInput.value.trim()); openList(); }
    });
    comboInput.addEventListener('focus', () => { fetchCustomers(comboInput.value.trim()); });
    comboInput.addEventListener('blur', () => setTimeout(closeList, 100));
    // preload (do not open)
    fetchCustomers('');
  </script>
{% endblock %}


